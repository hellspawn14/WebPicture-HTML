<! DOCTYPE html>
<meta charset="UTF-8">
<html lang="en">
<link rel="icon" href="../res/siteIcon.png" type="image/x-icon">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Index web site for WebPicture online DSL model editor">

<head>
    <title>WebPicture</title>
    <link rel="icon" href="../res/siteIcon.png" type="image/x-icon">
    <!-- JQuery -->
    <script src="http://code.jquery.com/jquery-2.1.1.js"></script>
    <script src="http://code.jquery.com/ui/jquery-ui-git.js"></script>
    <!-- Bootstrap -->
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <!-- Bootbox -->
    <script src="../bootbox/bootbox.js"></script>
    <!-- Pure CSS -->
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure//pure.css">
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/pure-min.css">
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure//grids-responsive.css">
    <link rel="stylesheet" href="../pure-css/css/layouts/marketing.css">
    <link rel="stylesheet" href="../pure-css/css/layouts/headers.css">
    <!-- Fort Awesome icons -->
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
    <!-- WebPicture2File -->
    <script src="../extras/canvas2image.js"></script>
    <script src="../extras/html2canvas.js"></script>
    <script src="../extras/FileSaver.js"></script>
    <script src="../extras/Blob.js"></script>
    <script src="http://canvg.googlecode.com/svn/trunk/canvg.js"></script>
    <script src="../extras/canvas-toBlob.js"></script>
    <!-- Scripts de Joint JS -->
    <script src="../js/lib/lodash.js"></script>
    <script src="../js/lib/backbone.js"></script>
    <script src="../js/src/core.js"></script>
    <script src="../js/src/vectorizer.js"></script>
    <script src="../js/src/geometry.js"></script>
    <script src="../js/src/joint.dia.graph.js"></script>
    <script src="../js/src/joint.dia.cell.js"></script>
    <script src="../js/src/joint.dia.element.js"></script>
    <script src="../js/src/joint.dia.link.js"></script>
    <script src="../js/src/joint.dia.paper.js"></script>
    <script src="../js/plugins/joint.shapes.basic.js"></script>
    <script src="../js/plugins/routers/joint.routers.orthogonal.js"></script>
    <script src="../js/plugins/routers/joint.routers.manhattan.js"></script>
    <script src="../js/plugins/routers/joint.routers.metro.js"></script>
    <script src="../js/plugins/connectors/joint.connectors.normal.js"></script>
    <script src="../js/plugins/connectors/joint.connectors.rounded.js"></script>
    <script src="../js/plugins/connectors/joint.connectors.smooth.js"></script>
    <script src="../js/dist/joint.shapes.org.js"></script>
    <link rel="stylesheet" href="../js/joint.css">
</head>

<body>
    <div class="header">
        <div class="home-menu pure-menu pure-menu-open pure-menu-horizontal pure-menu-fixed" style="background-color:#181818; position:fixed">
            <a class="pure-menu-heading" href="index.html">
                <img src="../res/logo.png" class="pure-img" />
            </a>
        </div>
    </div>
    <div class="pure-g">
        <!-- Paleta de elementos -->
        <div class="pure-u-1-5" style="text-align:center;border-right:1px solid #808080; height:100%; background-color:#181818; overflow-y: auto">
            <!-- Encabezado de la paleta de elementos -->
            <div class="hero-titles" style="background-color:#181818">
                <h3 class="marketing-header-canvas" style="text-align:center;color:white">Palette</h3>
            </div>
            <div id="tools">
                <h3 class="marketing-header-canvas" style="text-align:center;color:white; background-color:#181818;border-top:1px solid #808080"><i class="fa fa-chevron-circle-down"></i> Secction I</h3>
                <div id="grupo1" style="background-color:#FFFFFF; overflow-y: auto; height:100%; border-top:1px solid #808080; vertical-align: top">

                </div>
                <h3 class="marketing-header-canvas" style="text-align:center;color:white; background-color:#181818; border-top:1px solid #808080"><i class="fa fa-chevron-circle-down"></i> Secction II</h3>
                <div id="grupo2" style="background-color:#FFFFFF; overflow-y: auto; height:100%">

                </div>
                <h3 class="marketing-header-canvas" style="text-align:center;color:white; background-color:#181818; border-top:1px solid #808080"><i class="fa fa-chevron-circle-down"></i> Secction III</h3>
                <div id="grupo3" style="background-color:#FFFFFF; overflow-y: auto; height:100%">
                    <div id="grupo3" class="drag">
                    </div>
                </div>
                <h3 class="marketing-header-canvas" style="text-align:center;color:white; background-color:#181818; border-top:1px solid #808080"><i class="fa fa-chevron-circle-down"></i> Secction IV</h3>
                <div id="grupo4" style="background-color:#FFFFFF; overflow-y: auto; height:100%">
                </div>
            </div>
        </div>
        <!-- Area de trabajo o diagramas-->
        <div class="pure-u-4-5" style="text-align:center; height:100%; overflow-y: auto">
            <!-- Barra de herramientas -->
            <div class="hero-tool-bar" style="width:100%;background-color:#808080; height:5px">
                <div class="pure-g">
                    <div class="pure-u-1-6">
                        <button type="submit" class="pure-button" style="width:100%;border-right:3px solid #808080" onclick="goHomeSave()"><i class="fa fa-home"></i> Home</button>
                    </div>
                    <div class="pure-u-1-6">
                        <button type="submit" class="pure-button" style="width:100%;border-right:3px solid #808080" onclick="saveModel()"><i class="fa fa-floppy-o"></i> Save</button>
                    </div>
                    <div class="pure-u-1-6">
                        <button id="btnSave" type="submit" class="pure-button" style="width:100%;border-right:3px solid #808080" onclick="exportCanvas()"><i class="fa fa-download"></i> Export</button>
                    </div>
                    <div class="pure-u-1-6">
                        <button type="submit" class="pure-button" style="width:100%;border-right:3px solid #808080" onclick="clearCanvas()"><i class="fa fa-times"></i> Clear</button>
                    </div>
                    <div class="pure-u-1-6">
                        <button id="unDoBtn" type="submit" class="pure-button" style="width:100%;border-right:3px solid #808080" onclick="unDoLastChange()"><i class="fa fa-reply"></i> Undo</button>
                    </div>
                    <div class="pure-u-1-6">
                        <button id="reDoBtn" type="submit" class="pure-button" style="width:100%;border-right:3px solid #808080" onclick="reDoLastChange()"><i class="fa fa-share"></i> Redo</button>
                    </div>
                </div>
            </div>
            <!-- Canvas -->
            <div id="modelCanvas" style="height:100%;width:100%; overflow-y: auto; overflow-x: auto">

            </div>
        </div>
    </div>


    <!-- Script de pruba de la paleta -->
    <!--<script src="../../Editors/8e8745eb-bb31-423d-80f4-1ae5e15fba3d/Scripts/script.js"></script>-->
    <script>
        var graphGrupo1 = new joint.dia.Graph;
        var paperGrupo1 = new joint.dia.Paper({
            el: $('#grupo1'),
            gridSize: 10,
            height: 500,
            width: $('#tools').width(),
            gridSize: 1,
            model: graphGrupo1
        });

        var c = new joint.shapes.basic.Circle({
            position: {
                x: 10,
                y: 10
            },
            size: {
                width: 100,
                height: 100
            },
            attrs: {
                circle: {
                    fill: '#9B59B6',
                    opacity: 0.5
                },

                text: {
                    text: 'circle',
                    fill: 'black',
                    //'y-alignment': 'middle'

                },
            },
        });
        graphGrupo1.addCell(c);
        var rbx = new joint.shapes.basic.Rect({
            position: {
                x: 10,
                y: 120
            },
            size: {
                width: 100,
                height: 40
            },
            attrs: {
                text: {
                    text: 'basic.ola ke ase',
                    'y-alignment': 'middle'
                },
                rect: {
                    fill: '#2ECC71',
                    opacity: 0.5
                },
            }
        });

        graphGrupo1.addCell(rbx);

        var Circ5e481248 = new joint.shapes.basic.Circle({
            position: {
                x: 10,
                y: 180
            },
            size: {
                width: 100,
                height: 100
            },
            attrs: {
                circle: {
                    width: 100,
                    height: 100,
                    fill: '#00FFFF',
                    rx: 100,
                    ry: 100,
                    'stroke-width': 1,
                    stroke: '#000000',
                    'stroke-dasharray': '0,0',
                },
                text: {
                    text: 'Ola ke ase',
                    fill: 'black',
                    'font-size': 14,
                    'font-weight': 'normal'
                },
            }
        });
        graphGrupo1.addCell(Circ5e481248);

        paperGrupo1.findViewByModel(c).options.interactive = false;
        paperGrupo1.findViewByModel(c).options.DRAGDROP = true;
    </script>
    <script>
        var graph = new joint.dia.Graph;
        var paper = new joint.dia.Paper({
            el: $('#grupo2'),
            gridSize: 10,
            height: 1000,
            width: $('#tools').width(),
            gridSize: 1,
            model: graph
        });
        var rb = new joint.shapes.basic.Rect({
            position: {
                x: 10,
                y: 10
            },
            size: {
                width: 100,
                height: 40
            },
            attrs: {
                text: {
                    text: 'basic.Rect'
                }
            }
        });
        graph.addCell(rb);
        var rbx = new joint.shapes.basic.Rect({
            position: {
                x: 10,
                y: 60
            },
            size: {
                width: 100,
                height: 40
            },
            attrs: {
                text: {
                    text: 'basic.ola ke ase'
                }
            }
        });
        graph.addCell(rbx);
    </script>
    <!-- Script de pruba del canvas -->
    <script>
        //----------------------------------------------------------
         //Atributos 
         //----------------------------------------------------------

        /**
         * Posición del estado actual
         */
        var mainStateIndex = 0;

        /**
         * Estado actual del modelo
         */
        var mainState = null;

        /**
         * Lista con los estados del diagrama
         */
        var states = new Array();

        /**
         * Estado actual del diagrama
         */
        var currentState = null;

        /*
         * Estado pasado del diagrama
         */
        var lastState = null;

        /**
         * Estado del diagrama salvado
         */
        var savedDiagram = null;

        /**
         * Contenedor del modelo
         */
        var graph = new joint.dia.Graph;


        /**
         * Contenedor del diagrama
         */
        var paper = new joint.dia.Paper({
            el: $('#modelCanvas'),
            gridSize: 10,
            height: $('#modelCanvas').height(),
            width: $('#modelCanvas').width(),
            gridSize: 1,
            model: graph
        });

        var c = new joint.shapes.basic.Circle({
            position: {
                x: 20,
                y: 20
            },
            size: {
                width: 100,
                height: 100
            },
            attrs: {
                circle: {
                    fill: '#9B59B6',
                    opacity: 0.5,
                    magnet: true
                },

                text: {
                    text: 'circle',
                    fill: 'black',
                    //'y-alignment': 'middle',
                    'ref-y': -10
                },
            },
        });
        graph.addCell(c);

        var Image7f31245a = new joint.shapes.basic.Image({
            position: {
                x: 100,
                y: 100
            },
            size: {
                width: 50,
                height: 50
            },
            attrs: {


                type: 'EClass',
                text: {
                    text: 'cosplay'
                },
                image: {
                    magnet: true,
                    'xlink:href': 'http://img-9gag-lol.9cache.com/photo/a1ZPj9R_700b.jpg',
                    width: 50,
                    height: 50
                }
            }
        });

        graph.addCell(Image7f31245a);


        var ci = new joint.shapes.basic.Circle({
            position: {
                x: 500,
                y: 500
            },
            size: {
                width: 100,
                height: 100
            },
            attrs: {
                circle: {
                    fill: '#9B59B6',
                    opacity: 0.5,
                    magnet: true
                },

                text: {
                    text: 'circle',
                    fill: 'black',
                    'y-alignment': 'middle'
                },
            },
        });
        graph.addCell(ci);

        var member = function (x, y, name, image, background, border) {

            var cell = new joint.shapes.org.Member({
                position: {
                    x: x,
                    y: y
                },
                attrs: {
                    '.card': {
                        fill: background,
                        stroke: border,
                        magnet: true,
                    },
                    image: {
                        'xlink:href': image
                    },
                    /*
                    '.rank': {
                        text: rank
                    },*/

                    '.name': {
                        text: name,
                        'y-alignment': 'middle'
                        //'ref-y': -15
                    }
                }
            });
            graph.addCell(cell);
            return cell;
        };

        var memberX = function (x, y, rank, name, image, background, border) {

            var cell = new joint.shapes.org.Member({
                position: {
                    x: x,
                    y: y
                },
                attrs: {
                    '.card': {
                        fill: background,
                        stroke: border
                    },
                    image: {
                        'xlink:href': '/images/' + image
                    },
                    '.rank': {
                        text: rank
                    },
                    '.name': {
                        text: name
                    }
                }
            });
            graph.addCell(cell);
            return cell;
        };

        var bart = member(100, 70, 'Bart Simpson', 'http://icons.iconarchive.com/icons/jonathan-rey/simpsons/256/Bart-Simpson-01-icon.png', '#F1C40F', 'gray');
        var homer = memberX(90, 200, 'VP Marketing', 'Homer Simpson', 'member2.png', '#2ECC71', '#008e09');



         //----------------------------------------------------------
         //Funciones basicas del canvas 
         //----------------------------------------------------------

        /**
         * Inicializa los estados del diagrama
         */
        function startDiagram() {
            //Inicializa el estado principal 
            mainState = JSON.stringify(graph);
            states.push(mainState);
            //Reinicia el arreglo de estados
            while (states.length > 0) {
                states.pop();
            }
            mainStateIndex = 0;
            //Bloquea los botones 
            document.getElementById('unDoBtn').disabled = true;
            document.getElementById('reDoBtn').disabled = true;

        }

        /**
         * Actualiza los estados actuales del diagrama
         */
        function updateDiagram() {
            if (mainStateIndex == 0)
            {
               document.getElementById('unDoBtn').disabled = true; 
            }
            else{
                document.getElementById('unDoBtn').disabled = false;
            }
            
            if (mainStateIndex != states.length - 1) {
                document.getElementById('reDoBtn').disabled = true;
            } else {
                document.getElementById('reDoBtn').disabled = false;
            }
            //Nuevo estado a introducir 
            mainState = JSON.stringify(graph);
            //Esta en un estado intermedio no es el primero ni el ultimo 
            if (mainStateIndex != 0 || mainStateIndex != states.length - 1) {
                //Eliminar los estados que estan adelante 
                var i = mainStateIndex + 1;
                for (i; i < states.length; i++) {
                    //Elimina cada uno de los elementos desde la posicion dada hasta el final 
                    states.splice(i, 1);
                }
            }
            //Evita overflows en el arreglo (longitud controlada)
            if (states.length == 10) {
                states = states.slice(4);
            }
            //Inserta el nuevo estado y cambia el apuntador al estado actual
            states.push(mainState);
            mainStateIndex = states.length - 1;
        }

        /**
         * Retrocede un estado con respecto al actual y deshace el ultimo cambio hacia el estado anterior
         */
        function unDoLastChange() {
            //Tiene que estar en un estado diferente del primero para retroceder
            if (mainStateIndex != 0) {
                mainStateIndex = mainStateIndex - 1;
                mainState = states[mainStateIndex];
                graph.fromJSON(JSON.parse(mainState));
            }
        }

        /**
         * Avanza un estado con respecto al actual y rehace el ultimo cambio hacia el estado siguiente
         */
        function reDoLastChange() {
            if (mainStateIndex != states.length - 1) {
                mainStateIndex = mainStateIndex + 1;
                mainState = states[mainStateIndex];
                graph.fromJSON(JSON.parse(mainState));
            }
        }


        /**
         * Borra todo el contenido del Paper del canvas
         */
        function deleteAllContents() {
            graph.clear();
            updateDiagram();
        }

        /**
         * Restaura el contenido de un diagrama
         */
        function restoreDiagram(strJSON) {
            graph.fromJSON(JSON.parse(strJSON));
        }

        /** 
         * Guarda el contenido de un diagrama
         */
        function saveDiagram() {
            savedDiagram = JSON.stringify(graph);
            startDiagram();
        }

        /**
         * Exporta el contenido del modelo a un archivo SVG
         */
        function exportSVG() {
            var svgExp = this.paperToSVG();
            var blob = new Blob([svgExp], {
                type: "text/plain;charset=utf-8"
            });
            saveAs(blob, "model.svg");
        }

        /**
         * Exporta el contenido del modelo a un archivo PNG
         */
        function exportPNG() {
            var svgExp = this.paperToSVG();
            var image = new Image();
            image.src = 'data:image/svg+xml;base64,' + window.btoa(svgExp);
            image.onload = function () {
                var canvas = document.createElement('canvas');
                canvas.width = image.width;
                canvas.height = image.height;
                var context = canvas.getContext('2d');
                context.rect(0, 0, $('#modelCanvas').width(), $('#modelCanvas').height());
                context.fillStyle = "white";
                context.fill();
                context.drawImage(image, 0, 0);
                var a = document.createElement('a');
                a.download = "model.png";
                var sURL = canvas.toDataURL('image/png');
                a.href = sURL;
                document.body.appendChild(a);
                a.click();
            }
        }

        /**
         * Exporta el contenido del modelo a un archivo json
         */
        function exportToJSON() {
            var JSONExp = JSON.stringify(graph);
            var blob = new Blob([JSONExp], {
                type: "text/plain;charset=utf-8"
            });
            saveAs(blob, "model.json");
        }

        /**
         * Exporta el contenido del paper a SVG incluye las hojas de estilo y las correcciones
         */
        function paperToSVG() {
            var viewportTransform = V(paper.viewport).attr("transform");
            V(paper.viewport).attr("transform", "");
            var viewportBbox = paper.getContentBBox();
            var svgClone = paper.svg.cloneNode(true);
            V(paper.viewport).attr("transform", viewportTransform || "");
            svgClone.removeAttribute("style");
            V(svgClone).attr({
                width: "100%",
                height: "100%"
            });
            V(svgClone).attr("viewBox", viewportBbox.x + " " + viewportBbox.y + " " + viewportBbox.width + " " + viewportBbox.height);
            var styleSheetsCount = document.styleSheets.length;
            var styleSheetsCopy = [];
            for (var i = styleSheetsCount - 1; i >= 0; i--) {
                styleSheetsCopy[i] = document.styleSheets[i];
                document.styleSheets[i].disabled = true
            }
            var defaultComputedStyles = {};
            $(paper.svg).find("*").each(function (idx) {
                var computedStyle = window.getComputedStyle(this, null);
                var defaultComputedStyle = {};
                _.each(computedStyle, function (property) {
                    defaultComputedStyle[property] = computedStyle.getPropertyValue(property)
                });
                defaultComputedStyles[idx] = defaultComputedStyle
            });
            if (styleSheetsCount != document.styleSheets.length) {
                _.each(styleSheetsCopy, function (copy, i) {
                    document.styleSheets[i] = copy
                })
            }
            for (var i = 0; i < styleSheetsCount; i++) {
                document.styleSheets[i].disabled = false
            }
            var customStyles = {};
            $(paper.svg).find("*").each(function (idx) {
                var computedStyle = window.getComputedStyle(paper, null);
                var defaultComputedStyle = defaultComputedStyles[idx];
                var customStyle = {};
                _.each(computedStyle, function (property) {
                    if (computedStyle.getPropertyValue(property) !== defaultComputedStyle[property]) {
                        customStyle[property] = computedStyle.getPropertyValue(property)
                    }
                });
                customStyles[idx] = customStyle
            });
            $(svgClone).find("*").each(function (idx) {
                $(paper).css(customStyles[idx])
            });
            $(svgClone).find(".connection-wrap, .marker-vertices, .link-tools, .marker-arrowheads").remove();
            var svgString;
            try {
                var serializer = new XMLSerializer;
                svgString = serializer.serializeToString(svgClone);
            } catch (err) {
                console.error("Error serializing paper to SVG:", err)
            }
            return svgString;
        }

        /**
         * Notifica al modelo sobre cambios en el diagrama
         */
        graph.on('change', function (cell) {
            updateDiagram();
        });
    </script>
    <!-- Scripts -->
    <script>
        /*
         * Indica si los cambios en el canvas estan guardados en el servidor
         */
        var saved = 0;

         //---------------------------------------------------------------
         //Funciones botones barra herramientas
         //---------------------------------------------------------------

        /*
         * Verifica que el modelo esta guardado en el servidor (guarda de ser el caso) y redirecciona a la pagina inicial
         */
        function goHomeSave() {

            //Hay cambios sin salvar 
            if (saved === 0) {
                bootbox.dialog({
                    message: "There're unsaved changes would you like to save them?",
                    buttons: {
                        success: {
                            label: "Yes",
                            className: "btn-primary",
                            callback: function () {
                                saveModelImpl();
                                window.location.href = "webPictureActions.html";
                            }
                        },
                        danger: {
                            label: "No",
                            className: "btn-danger",
                            callback: function () {
                                window.location.href = "webPictureActions.html";
                            }
                        }
                    }
                });
            } else {
                window.location.href = "webPictureActions.html";
            }
        }

        /*
         * Guarda el estado del canvas en el servidor
         */
        function saveModel() {
            bootbox.alert("All changes saved on server", function () {
                saveModelImpl();
            });
        }

        /**
         * Implementación de la funcion para guardar el canvas
         */
        function saveModelImpl() {
            saved = 1;
            saveDiagram();

        }

        /*
         * Exporta el diagrama actual a png
         */
        function exportCanvas() {
            //Guarda el modelo 
            saveModelImpl();
            //Exporta y crea el archivo segun el caso
            bootbox.dialog({
                message: "Please choose an exporting format",
                buttons: {
                    toPNG: {
                        label: ".png",
                        className: "btn-primary",
                        callback: function () {
                            exportPNG();
                        }
                    },
                    toSVG: {
                        label: ".svg",
                        className: "btn-primary",
                        callback: function () {
                            exportSVG();
                        }
                    },
                    tojsonformat: {
                        label: ".json",
                        className: "btn-primary",
                        callback: function () {
                            exportToJSON();
                        }
                    }
                }
            });
        }

        /*
         * Borra todo el diagrama
         */
        function clearCanvas() {
            bootbox.dialog({
                message: "All elements in current diagram will be deleted, would you like to continue?",
                buttons: {
                    success: {
                        label: "Yes",
                        className: "btn-primary",
                        callback: function () {
                            clearCanvasImpl();
                        }
                    },
                    danger: {
                        label: "No",
                        className: "btn-danger",
                        callback: function () {
                            //Hacer nada
                        }
                    }
                }
            });
        }

        /**
         * Implementación de la funcion clear canvas
         */
        function clearCanvasImpl() {
            saved = 0;
            deleteAllContents();
        }
    </script>
    <!-- Script de acordion elementos de la paleta -->
    <script>
        $(function () {
            $("#tools").accordion({
                collapsible: true,
                heightStyle: "fill",
                //active: false
            });
        });
    </script>

    <!-- Script de inicialización de la ventana -->
    <script>
        window.onload = function () {
            startDiagram();
        };
    </script>
</body>

</html>